name: Publish Package

on:
  push:
    branches:
      - main
    paths:
      - "package.json"

  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  version-check:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.check.outputs.changed }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - id: check
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          before_version="$(git show "${{ github.event.before }}:package.json" 2>/dev/null | node -p "JSON.parse(require('node:fs').readFileSync(0, 'utf8')).version" || true)"
          after_version="$(node -p "require('./package.json').version")"

          echo "before_version=$before_version"
          echo "after_version=$after_version"

          if [ -n "$after_version" ] && [ "$before_version" != "$after_version" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

  publish-npm:
    needs: version-check
    if: needs.version-check.outputs.changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: package.json
          registry-url: https://registry.npmjs.org
          cache: "pnpm"

      - run: pnpm install --frozen-lockfile
      - run: pnpm build
      - run: pnpm test
      - run: pnpm publish --no-git-checks
